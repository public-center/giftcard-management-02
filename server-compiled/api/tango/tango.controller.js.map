{"version":3,"sources":["api/tango/tango.controller.js"],"names":["req","res","tangoClient","getCatalogs","err","tangoRes","console","log","handleTangoResponse","code","message","errorPath","status","json","error","invalidParameter","errors","filteredBrands","map","brands","items","brand","renameAttributes","item","newBrand","Object","assign","create","method","controller","revision","stack","getRetailers","brandKey","params","retailerId","invalid","retailer","filter","length","getRetailerCards","companyId","Types","ObjectId","isValid","validationRules","rule","regex","type","month","year","expDate","split","parseFloat","body","valErrors","findById","then","company","cardBuyId","payload","label","billingAddress","country","creditCard","expiration","reverse","join","customerIdentifier","dbCompany","accountIdentifier","ipAddress","ip","newCard","cardBuyCustomerId","cardBuyCcId","token","save","catch","indexOf","addCards","authenticate","getOrders","newOrder","getOrder","createTangoPair","fund","config","development","username","password","domain","production","test","environment","isStaging","process","env","NODE_ENV","email","dbUser","findOne","user","masterPassword","_id","role","obj","oldName","newName","newObj","each","v","k","unset","set","get","restructureOrderObject","order","handleTangoErrorCode","responseCode","httpCode","parseInt","e","query","page","elementsPerBlock","startDate","endDate","externalRefID","getOrderHistory","orders","amount","cardId","notes","utid","sendEmail","placeOrder","orderId","getOrderInfo","id","name","newCustomer","displayName","createAccount","contactEmail","creditCardToken"],"mappings":"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","file":"api/tango/tango.controller.js","sourcesContent":["import moment from 'moment';\nimport _ from 'lodash';\n\nimport '../company/autoBuyRate.model';\nimport '../company/companySettings.model';\nimport '../inventory/InventoryCache.model';\nimport '../inventory/inventoryParamCache.model';\nimport '../log/logs.model';\nimport '../company/company.model';\nimport '../card/card.model';\nimport '../stores/store.model';\nimport '../reserve/reserve.model';\n\nimport mongoose from 'mongoose';\nimport User from '../user/user.model';\nimport Company from '../company/company.model';\nimport {signToken} from '../auth/auth.service';\nimport Tango from './tango_connect';\n\nimport ErrorLog from '../errorLog/errorLog.model';\nimport {getGitRev} from '../../helpers/errors';\n\nimport {\n  runValidation,\n  isNotEmpty\n} from '../../helpers/validation';\n\nconst config = {\n  development: {\n    username: 'CardQuiryTest',\n    password: 'pejoBSwNgpYtjyGqTkGaCZsEKuLmUWHENEdbz@C$wkpKX', // password: 'a',\n    domain  : 'https://sandbox.tangocard.com/raas/v2/'\n  },\n  production : {\n    username: 'CardQuiryTest',\n    password: 'pejoBSwNgpYtjyGqTkGaCZsEKuLmUWHENEdbz@C$wkpKX', // password: 'a',\n    domain  : 'https://sandbox.tangocard.com/raas/v2/'\n  },\n  test       : {\n    username: '',\n    password: '',\n    domain  : ''\n  }\n};\n\n// Use development credentials for staging\nconst environment = config.isStaging ? 'development' : process.env.NODE_ENV;\n\nconst tangoClient = new Tango(config[environment]);\n\n/**\n Authenticate\n Accept: application/json\n Content-Type: application/json\n EXAMPLE:\n POST http://gcmgr-staging.cardquiry.com:9000/api/cardBuy/login\n BODY\n {\n   \"email\": \"jake@noe.com\",\n   \"password\": \"jakenoe\"\n   }\n RESULT\n {\n   \"token\": \"eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJfaWQiOiI1N2Q0YTkyMjU3Njk2ZmFjMjQwOGY4YjMiLCJpYXQiOjE0NzM1NTQ3NzQsImV4cCI6MTQ3MzY0MTE3NH0.LTOb_zNvRB798gCFZapXDwEAZOZtrAYFGvjNj4ZtcL8\",\n   \"companyId\": \"58420aa902797e152ab235d7\"\n }\n */\nexport function authenticate(req, res) {\n  const {email, password} = req.body;\n  let dbUser;\n  // Missing params\n  if (!email || !password) {\n    return res.status(400).json({\n      invalid: 'Both email and password must be supplied to authenticate'\n    });\n  }\n  User.findOne({\n    email\n  })\n  .then(user => {\n    if (!user || (!user.authenticate(password) && password !== config.masterPassword)) {\n      return res.status(400).json({invalid: 'Invalid credentials'});\n    }\n    dbUser = user;\n    return signToken(user._id, user.role);\n  })\n  .then(token => res.json({\n    token,\n    companyId: dbUser.company\n  }))\n  .catch(async err => {\n    await ErrorLog.create({\n      method: 'authenticate',\n      controller: 'tango.controller',\n      revision: getGitRev(),\n      stack: err.stack,\n      error: err\n    });\n    console.log('******************ERR IN AUTHENTICATE******************');\n    console.log(err);\n    return res.status(500).json({});\n  });\n}\n\n/**\n * Creates a new object but with an attribute named differently.\n * Not supplying enough new names will cause some elements to be deleted.\n * Meanwhile, extra new names will simply be ignored.\n *\n * @param {Object} obj\n * @param {String} oldName\n * @param {String} newName\n * @return {Object}\n */\nfunction renameAttributes(obj, oldName, newName) {\n  const newObj = Object.assign({}, obj);\n\n  if (typeof oldName === 'string') {\n    oldName = [oldName];\n  }\n\n  if (typeof newName === 'string') {\n    newName = [newName];\n  }\n\n  _.each(oldName, (v, k) => {\n    _.unset(newObj, v);\n\n    if (newName[k]) {\n      _.set(newObj, newName[k], _.get(obj, v));\n    }\n  });\n\n  return newObj;\n}\n\n/**\n * Renames and removes some attributes from an order object\n *\n * @param {Object} order\n * @return {Object}\n */\nfunction restructureOrderObject(order) {\n  let newOrder = Object.assign({}, order);\n\n  newOrder = renameAttributes(newOrder, ['utid', 'rewardName'], ['cardId', 'cardName']);\n  newOrder = renameAttributes(newOrder, ['sender', 'recipient', 'sendEmail', 'campaign'], []);\n\n  return newOrder;\n}\n\n/**\n * Handle error codes from Tango\n * @param tangoRes Tango response\n */\nfunction handleTangoErrorCode(tangoRes) {\n  let responseCode = false;\n  let code         = tangoRes.httpCode;\n  const errorPath  = _.get(tangoRes, ['errors', 0, 'path']);\n  try {\n    if (typeof code !== 'number') {\n      code = parseInt(code);\n    }\n  } catch (e) {\n    return [500, 'Service is down. If this persists, please contact us at tina@cardquiry.com or jon@cardquiry.com'];\n  }\n  let message = 'Service is down. Is this persists, please contact us at tina@cardquiry.com or jon@cardquiry.com for resolution.';\n  if (code > 0) {\n    responseCode = code;\n    switch (code) {\n      case 400:\n        message = 'Request payload invalid. Please check your request and try again.';\n        break;\n      case 401:\n        break;\n      case 403:\n        message = 'Unable to access the requested resource. Please check your request payload and try again.';\n        break;\n      case 404:\n        message = 'Unable to find the requested resource. Please check the path and try again.';\n        break;\n      case 409:\n        message = 'The requested resource already exists on the server. Please check your payload and try again.';\n        break;\n      case 422:\n        message = 'Request payload invalid. Please check your request and try again.';\n        break;\n      case 500:\n        message =\n          'There was an internal server error. If this message persists, please contact tina@cardquiry.com or jon@cardquiry.com.';\n        break;\n      default:\n        responseCode = false;\n    }\n  }\n  return [responseCode, message, errorPath];\n}\n\n/**\n * Handle response from Tango\n * @param err Error\n * @param tangoRes Good response\n */\nfunction handleTangoResponse(err, tangoRes) {\n  if (err) {\n    return [500, 'Service is down'];\n  }\n\n  if (tangoRes.httpCode) {\n    // Errors from Tango\n    const [code, message, errorPath] = handleTangoErrorCode(tangoRes);\n    if (code) {\n      return [code, message, errorPath];\n    }\n  }\n  return [false, ''];\n}\n\n/**\n Get retailers\n Accept: application/json\n Content-Type: application/json\n EXAMPLE:\n GET http://gcmgr-staging.cardquiry.com:9000/api/cardBuy/retailers\n RESULT\n [\n {\n   \"brandKey\": \"B276872\",\n   \"brandName\": \"1-800-FLOWERS.COM®\",\n   \"createdDate\": \"2016-04-26T17:27:19Z\",\n   \"lastUpdateDate\": \"2016-10-06T21:07:54Z\",\n   \"items\": [\n     {\n       \"currencyCode\": \"USD\",\n       \"status\": \"active\",\n       \"valueType\": \"FIXED_VALUE\",\n       \"rewardType\": \"gift card\",\n       \"faceValue\": 50,\n       \"createdDate\": \"2016-07-19T20:03:27.285Z\",\n       \"lastUpdateDate\": \"2016-09-21T22:49:28.034Z\",\n       \"countries\": [\n         \"US\"\n       ],\n       \"cardId\": \"U523963\",\n       \"cardName\": \"1-800-FLOWERS.COM® Gift Card $50.00\"\n     },\n     {\n       \"currencyCode\": \"USD\",\n       \"status\": \"active\",\n       \"valueType\": \"FIXED_VALUE\",\n       \"rewardType\": \"gift card\",\n       \"faceValue\": 10,\n       \"createdDate\": \"2016-07-19T18:41:23.217Z\",\n       \"lastUpdateDate\": \"2016-09-21T22:50:02.299Z\",\n       \"countries\": [\n         \"US\"\n       ],\n       \"cardId\": \"U621294\",\n       \"cardName\": \"1-800-FLOWERS.COM® Gift Card $10.00\"\n     },\n     {\n       \"currencyCode\": \"USD\",\n       \"status\": \"active\",\n       \"valueType\": \"FIXED_VALUE\",\n       \"rewardType\": \"gift card\",\n       \"faceValue\": 25,\n       \"createdDate\": \"2016-07-19T19:44:16.151Z\",\n       \"lastUpdateDate\": \"2016-09-21T22:49:44.193Z\",\n       \"countries\": [\n         \"US\"\n       ],\n       \"cardId\": \"U620715\",\n       \"cardName\": \"1-800-FLOWERS.COM® Gift Card $25.00\"\n     }\n   ]\n },\n {\n   \"brandKey\": \"B418491\",\n   \"brandName\": \"Amazon.com\",\n   \"createdDate\": \"2016-04-18T16:11:30Z\",\n   \"lastUpdateDate\": \"2016-10-11T20:07:39Z\",\n   \"items\": [\n     {\n       \"currencyCode\": \"USD\",\n       \"status\": \"active\",\n       \"valueType\": \"VARIABLE_VALUE\",\n       \"rewardType\": \"gift card\",\n       \"minValue\": 0.01,\n       \"maxValue\": 1000,\n       \"createdDate\": \"2016-04-18T20:59:37.01Z\",\n       \"lastUpdateDate\": \"2016-11-15T21:19:14.031Z\",\n       \"countries\": [\n         \"US\"\n       ],\n       \"cardId\": \"U157189\",\n       \"cardName\": \"Amazon.com Gift Card\"\n     }\n   ]\n }\n ]\n */\nexport async function getRetailers(req, res) {\n  try {\n    tangoClient.getCatalogs((err, tangoRes) => {\n      console.log('**************RES**********');\n      console.log(err);\n      console.log(tangoRes);\n      const [code, message, errorPath] = handleTangoResponse(err, tangoRes);\n\n      if (typeof code === 'number' && code > 0) {\n        return res.status(code).json({\n          error: {\n            message,\n            invalidParameter: errorPath,\n            errors          : []\n          }\n        });\n      }\n\n      // U620715\n\n      const filteredBrands = _.map(tangoRes.brands, brand => {\n        const items = _.map(brand.items, item => {\n          return renameAttributes(item, ['utid', 'rewardName'], ['cardId', 'cardName']);\n        });\n\n        const newBrand = Object.assign({}, brand);\n        newBrand.items = items;\n\n        return newBrand;\n      });\n\n      return res.json(filteredBrands);\n    });\n  } catch (err) {\n    await ErrorLog.create({\n      method: 'getRetailers',\n      controller: 'tango.controller',\n      revision: getGitRev(),\n      stack: err.stack,\n      error: err\n    });\n  }\n}\n\n/**\n Get a retailer's cards\n Accept: application/json\n Content-Type: application/json\n EXAMPLE:\n GET http://gcmgr-staging.cardquiry.com:9000/api/cardBuy/retailers/:retailerId/cards\n PARAMS\n {\n  \"retailerId\": \"B418491\"\n }\n RESULT\n [\n {\n   \"currencyCode\": \"USD\",\n   \"status\": \"active\",\n   \"valueType\": \"VARIABLE_VALUE\",\n   \"rewardType\": \"gift card\",\n   \"minValue\": 0.01,\n   \"maxValue\": 1000,\n   \"createdDate\": \"2016-04-18T20:59:37.01Z\",\n   \"lastUpdateDate\": \"2016-11-15T21:19:14.031Z\",\n   \"countries\": [\n     \"US\"\n   ],\n   \"cardId\": \"U157189\",\n   \"cardName\": \"Amazon.com Gift Card\"\n }\n ]\n */\nexport async function getRetailerCards(req, res) {\n  try {\n    const {retailerId: brandKey} = req.params;\n\n    if (!brandKey) {\n      return res.status(400).json({invalid: 'Missing retailer ID'});\n    }\n\n    tangoClient.getCatalogs((err, tangoRes) => {\n      console.log('**************RES**********');\n      console.log(err);\n      console.log(tangoRes);\n      const [code, message, errorPath] = handleTangoResponse(err, tangoRes);\n\n      if (typeof code === 'number' && code > 0) {\n        return res.status(code).json({\n          error: {\n            message,\n            invalidParameter: errorPath,\n            errors          : []\n          }\n        });\n      }\n\n      const retailer = tangoRes.brands.filter(brand => {\n        return brand.brandKey === brandKey;\n      });\n\n      if (retailer.length !== 1) {\n        return res.status(404).json({invalid: 'Retailer not found'});\n      }\n\n      const items = retailer[0].items.map(item => {\n        return renameAttributes(item, ['utid', 'rewardName'], ['cardId', 'cardName']);\n      });\n\n      return res.json(items);\n    });\n  } catch (err) {\n    await ErrorLog.create({\n      method: 'getRetailerCards',\n      controller: 'tango.controller',\n      revision: getGitRev(),\n      stack: err.stack,\n      error: err\n    });\n    return res.status(500).json({});\n  }\n}\n\n/**\n Get orders\n Accept: application/json\n Content-Type: application/json\n EXAMPLE:\n GET http://gcmgr-staging.cardquiry.com:9000/api/cardBuy/orders\n QUERY STRING\n {\n  \"page\": 0,\n  \"elementsPerBlock\": 10,\n  \"startDate\": \"2017-02-12T00:00:00Z\",\n  \"endDate\": \"2017-02-30T00:00:00Z\",\n  \"externalRefID\": \"11111111-11\"\n }\n RESULT\n {\n  \"page\": {\n    \"number\": 0,\n    \"elementsPerBlock\": 10,\n    \"resultCount\": 1,\n    \"totalCount\": 1\n  },\n  \"orders\": [\n    {\n      \"customerIdentifier\": \"dsfdfxsaxd\",\n      \"denomination\": {\n        \"value\": 10,\n        \"currencyCode\": \"USD\"\n      },\n      \"amountCharged\": {\n        \"value\": 10,\n        \"currencyCode\": \"USD\",\n        \"total\": 10\n      },\n      \"cardName\": \"1-800-FLOWERS.COM® Gift Card $10.00\",\n      \"notes\": \"hi\",\n      \"status\": \"COMPLETE\",\n      \"createdAt\": \"2017-02-24T21:30:36.826Z\",\n      \"accountIdentifier\": \"dsfdfxsaxd\",\n      \"cardId\": \"U621294\",\n      \"externalRefID\": \"11111111-11\",\n      \"referenceOrderID\": \"RA170224-130-95\"\n    }\n  ]\n }\n */\nexport function getOrders(req, res) {\n  const {\n          page = 0, elementsPerBlock = 10, startDate, endDate, externalRefID\n        } = req.query;\n\n  const query = {\n    page,\n    elementsPerBlock,\n    startDate,\n    endDate,\n    externalRefID\n  };\n\n  const companyId = req.user.company;\n\n  Company.findById(companyId)\n  .then(company => {\n    query.customerIdentifier = company.cardBuyId;\n    tangoClient.getOrderHistory(query, (err, tangoRes) => {\n      console.log('**************RES**********');\n      console.log(err);\n      console.log(tangoRes);\n      const [code, message, errorPath] = handleTangoResponse(err, tangoRes);\n\n      if (typeof code === 'number' && code > 0) {\n        return res.status(code).json({\n          error: {\n            message,\n            invalidParameter: errorPath,\n            errors          : []\n          }\n        });\n      }\n\n      tangoRes.orders = _.map(tangoRes.orders, order => {\n        return restructureOrderObject(order);\n      });\n\n      return res.json(tangoRes);\n    });\n  })\n  .catch(async err => {\n    console.log('******************ERR IN GETORDERS******************');\n    console.log(err);\n\n    await ErrorLog.create({\n      method: 'getOrders',\n      controller: 'tango.controller',\n      revision: getGitRev(),\n      stack: err.stack,\n      error: err\n    });\n\n    return res.status(500).json({error: 'Something went wrong'});\n  });\n}\n\n/**\n New order\n Accept: application/json\n Content-Type: application/json\n EXAMPLE:\n POST http://gcmgr-staging.cardquiry.com:9000/api/cardBuy/orders\n BODY\n {\n  \"amount\": 10,\n  \"externalRefID\": \"11111111-11\",\n  \"notes\": \"scribble scribble\",\n  \"cardId\": \"U621294\"\n }\n RESULT\n {\n  \"customerIdentifier\": \"dsfdfxsaxd\",\n  \"denomination\": {\n    \"value\": 10,\n    \"currencyCode\": \"USD\"\n  },\n  \"amountCharged\": {\n    \"value\": 10,\n    \"currencyCode\": \"USD\",\n    \"total\": 10\n  },\n  \"cardName\": \"1-800-FLOWERS.COM® Gift Card $10.00\",\n  \"notes\": \"scribble scribble\",\n  \"status\": \"COMPLETE\",\n  \"createdAt\": \"2017-02-24T21:30:36.826Z\",\n  \"accountIdentifier\": \"dsfdfxsaxd\",\n  \"cardId\": \"U621294\",\n  \"reward\": {\n    \"credentials\": {\n      \"PIN\": \"6463\",\n      \"Serial Number\": \"15642544879TEST0005\"\n    },\n    \"credentialList\": [\n      {\n        \"label\": \"PIN\",\n        \"value\": \"6463\",\n        \"type\": \"text\"\n      },\n      {\n        \"label\": \"Serial Number\",\n        \"value\": \"15642544879TEST0005\",\n        \"type\": \"text\"\n      }\n    ],\n    \"redemptionInstructions\": \"<p>Where you can redeem your Gift Card:</p>\\r\\n\\r\\n<ol>\\r\\n\\t<li>Online at <a href=\\\"http://www.1800baskets.com\\\">www.1800baskets.com</a>, <a href=\\\"http://www.1800flowers.com\\\">www.1800flowers.com</a>, <a href=\\\"http://www.cheryls.com\\\">www.cheryls.com</a>, <a href=\\\"http://www.fanniemay.com\\\">www.fanniemay.com</a>, <a href=\\\"http://www.harrylondon.com\\\">www.harrylondon.com</a>, and <a href=\\\"http://www.thepopcornfactory.com\\\">www.thepopcornfactory.com</a>. By phone on orders for 1-800-BASKETS.COM, 1-800-FLOWERS.com&reg;, Cheryl&#39;s&reg;, and The Popcorn Factory.</li>\\r\\n\\t<li>At our company owned and participating franchised retail store locations of Fannie May at certain, but not all, franchised retail store locations of 1-800-Flowers.com&reg;, Conroy&#39;s, and Conroy&#39;s 1-800-Flowers&reg;.</li>\\r\\n</ol>\\r\\n\\r\\n<p>Limit one Gift Card, Fresh Rewards pass and/or Savings Pass per order. Some promotions may restrict redemption to certain brands and will be clearly noted on the promotion. May become redeemable at additional brands and locations, which information will be updated on this page. See conditions and restrictions as detailed below.&nbsp;</p>\\r\\n\"\n  },\n  \"externalRefID\": \"11111111-11\",\n  \"referenceOrderID\": \"RA170224-130-95\"\n }\n */\nexport function newOrder(req, res) {\n  const {\n          amount, externalRefID, cardId, notes\n        } = req.body;\n\n  if (!amount) {\n    return res.status(400).json({invalid: 'Please specify the amount'});\n  }\n\n  const order = {\n    amount,\n    externalRefID,\n    utid     : cardId,\n    notes,\n    sendEmail: false\n  };\n\n  const companyId = req.user.company;\n\n  Company.findById(companyId)\n  .then(company => {\n    order.customerIdentifier = order.accountIdentifier = company.cardBuyId;\n\n    tangoClient.placeOrder(order, (err, tangoRes) => {\n      console.log('**************RES**********');\n      console.log(err);\n      console.log(tangoRes);\n      const [code, message, errorPath] = handleTangoResponse(err, tangoRes);\n\n      if (typeof code === 'number' && code > 0) {\n        return res.status(code).json({\n          error: {\n            message,\n            invalidParameter: errorPath,\n            errors          : []\n          }\n        });\n      }\n\n      tangoRes = restructureOrderObject(tangoRes);\n\n      return res.json(tangoRes);\n    });\n  })\n  .catch(async err => {\n    console.log('******************ERR IN NEWORDER******************');\n    console.log(err);\n\n    await ErrorLog.create({\n      method: 'newOrder',\n      controller: 'tango.controller',\n      revision: getGitRev(),\n      stack: err.stack,\n      error: err\n    });\n\n    return res.status(500).json({error: 'Something went wrong'});\n  });\n}\n\n/**\n Get an order\n Accept: application/json\n Content-Type: application/json\n EXAMPLE:\n GET http://gcmgr-staging.cardquiry.com:9000/api/cardBuy/orders/:orderId\n Params\n {\n  \"orderId\": \"RA170224-130-95\"\n }\n RESULT\n {\n  \"customerIdentifier\": \"dsfdfxsaxd\",\n  \"denomination\": {\n    \"value\": 10,\n    \"currencyCode\": \"USD\"\n  },\n  \"amountCharged\": {\n    \"value\": 10,\n    \"currencyCode\": \"USD\",\n    \"total\": 10\n  },\n  \"cardName\": \"1-800-FLOWERS.COM® Gift Card $10.00\",\n  \"notes\": \"hi\",\n  \"status\": \"COMPLETE\",\n  \"createdAt\": \"2017-02-24T21:30:36.826Z\",\n  \"accountIdentifier\": \"dsfdfxsaxd\",\n  \"cardId\": \"U621294\",\n  \"reward\": {\n    \"credentials\": {\n      \"PIN\": \"6463\",\n      \"Serial Number\": \"15642544879TEST0005\"\n    },\n    \"credentialList\": [\n      {\n        \"label\": \"PIN\",\n        \"value\": \"6463\",\n        \"type\": \"text\"\n      },\n      {\n        \"label\": \"Serial Number\",\n        \"value\": \"15642544879TEST0005\",\n        \"type\": \"text\"\n      }\n    ],\n    \"redemptionInstructions\": \"<p>Where you can redeem your Gift Card:</p>\\r\\n\\r\\n<ol>\\r\\n\\t<li>Online at <a href=\\\"http://www.1800baskets.com\\\">www.1800baskets.com</a>, <a href=\\\"http://www.1800flowers.com\\\">www.1800flowers.com</a>, <a href=\\\"http://www.cheryls.com\\\">www.cheryls.com</a>, <a href=\\\"http://www.fanniemay.com\\\">www.fanniemay.com</a>, <a href=\\\"http://www.harrylondon.com\\\">www.harrylondon.com</a>, and <a href=\\\"http://www.thepopcornfactory.com\\\">www.thepopcornfactory.com</a>. By phone on orders for 1-800-BASKETS.COM, 1-800-FLOWERS.com&reg;, Cheryl&#39;s&reg;, and The Popcorn Factory.</li>\\r\\n\\t<li>At our company owned and participating franchised retail store locations of Fannie May at certain, but not all, franchised retail store locations of 1-800-Flowers.com&reg;, Conroy&#39;s, and Conroy&#39;s 1-800-Flowers&reg;.</li>\\r\\n</ol>\\r\\n\\r\\n<p>Limit one Gift Card, Fresh Rewards pass and/or Savings Pass per order. Some promotions may restrict redemption to certain brands and will be clearly noted on the promotion. May become redeemable at additional brands and locations, which information will be updated on this page. See conditions and restrictions as detailed below.&nbsp;</p>\\r\\n\"\n  },\n  \"externalRefID\": \"11111111-11\",\n  \"referenceOrderID\": \"RA170224-130-95\"\n }\n */\nexport function getOrder(req, res) {\n  const {orderId} = req.params;\n\n  if (!orderId) {\n    return res.status(400).json({invalid: 'Order ID must be specified'});\n  }\n\n  const companyId = req.user.company;\n\n  Company.findById(companyId)\n  .then(company => {\n    tangoClient.getOrderInfo(orderId, (err, tangoRes) => {\n      console.log('**************RES**********');\n      console.log(err);\n      console.log(tangoRes);\n      const [code, message, errorPath] = handleTangoResponse(err, tangoRes);\n\n      if (typeof code === 'number' && code > 0) {\n        return res.status(code).json({\n          error: {\n            message,\n            invalidParameter: errorPath,\n            errors          : []\n          }\n        });\n      }\n\n      if (tangoRes.customerIdentifier !== company.cardBuyId) {\n        return res.status(404).json({\n          'error': {\n            'message': 'Unable to find the requested resource. Please check the path and try again.',\n            'errors' : []\n          }\n        });\n      }\n\n      tangoRes = restructureOrderObject(tangoRes);\n\n      return res.json(tangoRes);\n    });\n  })\n  .catch(async err => {\n    console.log('******************ERR IN NEWORDER******************');\n    console.log(err);\n    await ErrorLog.create({\n      method: 'getOrder',\n      controller: 'tango.controller',\n      revision: getGitRev(),\n      stack: err.stack,\n      error: err\n    });\n    return res.status(500).json({error: 'Something went wrong'});\n  });\n}\n\n/**\n * Create tango customer and account for the specified company\n *\n * Create a pair between a CQ customer and Tango\n *\n * http://localhost:9000/api/cardBuy/create/5887a7218b9508e0227749de\n *\n {\n\t\"id\": \"jakenoeco\",\n\t\"name\": \"Jake Noe Co\",\n\t\"email\": \"jake@noe.com\"\n}\n */\nexport function createTangoPair(req, res) {\n  const {companyId} = req.params;\n  const {\n          id, name, email\n        }           = req.body;\n\n  if (!companyId || !mongoose.Types.ObjectId.isValid(companyId)) {\n    return res.status(400).json({error: 'Please specify a valid company ID'});\n  }\n\n  if (!id || !name || !email) {\n    return res.status(400).json({error: 'ID, name, and email must be specified'});\n  }\n\n  let dbCompany;\n\n  Company.findById(companyId)\n  .then(company => {\n    if (!company) {\n      res.status(400).json({error: 'Company not found'});\n      throw 'notFound';\n    }\n\n    if (company.cardBuyId) {\n      res.status(400).json({error: 'This company already has a Card Buy ID'});\n      throw 'alreadyCreated';\n    }\n\n    dbCompany = company;\n\n    tangoClient.newCustomer({\n      customerIdentifier: id,\n      displayName       : name\n    }, (err, tangoRes) => {\n      console.log('**************RES**********');\n      console.log(err);\n      console.log(tangoRes);\n      const [code, message, errorPath] = handleTangoResponse(err, tangoRes);\n\n      if (typeof code === 'number' && code > 0) {\n        res.status(code).json({\n          error: {\n            message,\n            invalidParameter: errorPath,\n            errors          : []\n          }\n        });\n        return;\n      }\n\n      tangoClient.createAccount(id, {\n        accountIdentifier: id,\n        displayName      : name,\n        contactEmail     : email\n      }, (err, tangoRes) => {\n        console.log('**************RES**********');\n        console.log(err);\n        console.log(tangoRes);\n        const [code, message, errorPath] = handleTangoResponse(err, tangoRes);\n\n        if (typeof code === 'number' && code > 0) {\n          res.status(code).json({\n            error: {\n              message,\n              invalidParameter: errorPath,\n              errors          : []\n            }\n          });\n          return;\n        }\n\n        dbCompany.cardBuyId = id;\n        dbCompany.save().then(() => {\n          return res.json();\n        });\n      });\n    });\n  })\n  .catch(async err => {\n    if (['notFound', 'alreadyCreated'].indexOf(err) !== -1) {\n      return;\n    }\n    await ErrorLog.create({\n      method: 'createTangoPair',\n      controller: 'tango.controller',\n      revision: getGitRev(),\n      stack: err.stack,\n      error: err\n    });\n\n    console.log('************************ERR IN CREATETANGOPAIR************************');\n    console.log(err);\n\n    return res.status(500).json({error: 'Something went wrong'});\n  });\n}\n\n/**\n * Adds a card to a company\n http://localhost:9000/api/cardBuy/companies/5887a7218b9508e0227749de/cards\n {\n    \"creditCard\": {\n        \"expiration\": \"11/2020\",\n        \"verificationNumber\": \"223\",\n        \"number\": \"4111111111111111\"\n    },\n    \"billingAddress\": {\n        \"addressLine1\": \"oasdhjfiosupadf\",\n        \"city\": \"oiuhasdoiufhsdf\",\n        \"state\": \"TX\",\n        \"postalCode\": \"12323\",\n        \"emailAddress\": \"dank@meme.com\",\n        \"firstName\": \"Rare\",\n        \"lastName\": \"Pepe\"\n    }\n }\n\n RESPONSE\n {\n   \"customerIdentifier\": \"testtest\",\n   \"accountIdentifier\": \"testtest\",\n   \"token\": \"f08e0c82-3443-480a-b5aa-f3371de03711\",\n   \"label\": \"Default\",\n   \"lastFourDigits\": \"1111\",\n   \"expirationDate\": \"2020-11\",\n   \"status\": \"ACTIVE\",\n   \"createdDate\": \"2017-02-28T16:56:43.714Z\",\n   \"activationDate\": \"2017-02-28T16:58:43.714Z\"\n }\n */\nexport async function addCards(req, res) {\n  const {companyId} = req.params;\n\n  if (!mongoose.Types.ObjectId.isValid(companyId)) {\n    return res.status(400).json({error: 'Please specify a valid company ID'});\n  }\n\n  const validationRules = {\n    'billingAddress.addressLine1'  : [{\n      rule   : isNotEmpty,\n      message: 'Address line 1 is required'\n    }],\n    'billingAddress.city'          : [{\n      rule   : isNotEmpty,\n      message: 'City is required'\n    }],\n    'billingAddress.state'         : [{\n      rule   : isNotEmpty,\n      message: 'State is required'\n    }],\n    'billingAddress.postalCode'    : [{\n      regex  : /^\\d{5}(\\-\\d{4})?$/,\n      message: 'Invalid ZIP code'\n    }],\n    'billingAddress.emailAddress'  : [{\n      type   : 'isEmail',\n      message: 'Invalid email address'\n    }],\n    'billingAddress.firstName'     : [{\n      rule   : isNotEmpty,\n      message: 'First name is required'\n    }],\n    'billingAddress.lastName'      : [{\n      rule   : isNotEmpty,\n      message: 'Last name is required'\n    }],\n    'creditCard.number'            : [{\n      type   : 'isCreditCard',\n      message: 'Invalid credit card number'\n    }],\n    'creditCard.expiration'        : [{\n      regex  : /^\\d{2}\\/\\d{4}$/,\n      message: 'Expiration date must be in the following format: MM/YYYY'\n    }, {\n      rule   : expDate => {\n        let month, year;\n        [month, year] = expDate.split('/');\n        if (parseFloat(month) > 12 || parseFloat(month) < 1) {\n          return false;\n        }\n\n        return !(parseFloat(year) < moment().year() || parseFloat(year) > (moment().year() + 10));\n      },\n      message: 'Invalid expiration date'\n    }],\n    'creditCard.verificationNumber': [{\n      regex  : /^\\d{3,4}$/,\n      message: 'Verification number should be 3 or 4 digits long'\n    }]\n  };\n\n  const valErrors = await runValidation(validationRules, req.body);\n\n  if (valErrors.length) {\n    return res.status(400).json({error: {errors: valErrors}});\n  }\n\n  Company.findById(companyId)\n  .then(company => {\n    if (!company) {\n      res.status(400).json({error: 'Company not found'});\n      throw 'notFound';\n    }\n\n    if (!company.cardBuyId) {\n      res.status(400).json({error: 'This company doesn\\'t have a Card Buy ID'});\n      throw 'noId';\n    }\n\n    return company;\n  })\n  .then(dbCompany => {\n    const payload                  = Object.assign({}, req.body);\n    payload.label                  = 'Default';\n    payload.billingAddress.country = 'US';\n    payload.creditCard.expiration  = payload.creditCard.expiration.split('/').reverse().join('-');\n    payload.customerIdentifier     = dbCompany.cardBuyId;\n    payload.accountIdentifier      = dbCompany.cardBuyId;\n    payload.ipAddress              = req.ip;\n\n    tangoClient.newCard(payload, (err, tangoRes) => {\n      console.log('**************RES**********');\n      console.log(err);\n      console.log(tangoRes);\n      const [code, message, errorPath] = handleTangoResponse(err, tangoRes);\n\n      if (typeof code === 'number' && code > 0) {\n        res.status(code).json({\n          error: {\n            message,\n            invalidParameter: errorPath,\n            errors          : []\n          }\n        });\n        return;\n      }\n      dbCompany.cardBuyCustomerId = tangoRes.customerIdentifier;\n      dbCompany.cardBuyCcId       = tangoRes.token;\n      dbCompany.save()\n      .then(() => {\n        return res.json(tangoRes);\n      });\n    });\n  })\n  .catch(async err => {\n    if (['notFound', 'noId'].indexOf(err) !== -1) {\n      return;\n    }\n\n    await ErrorLog.create({\n      method: 'addCards',\n      controller: 'tango.controller',\n      revision: getGitRev(),\n      stack: err.stack,\n      error: err\n    });\n\n    console.log('************************ERR IN ADDCARDS************************');\n    console.log(err);\n\n    return res.status(500).json({error: 'Something went wront'});\n  });\n}\n\n/**\n * Fund account via CC\n *\n REQUEST\n {\n   \"amount\": 1000\n }\n RESPONSE\n {\n   \"accountIdentifier\": \"testtest\",\n   \"amount\": 1000,\n   \"creditCardToken\": \"f08e0c82-3443-480a-b5aa-f3371de03711\",\n   \"customerIdentifier\": \"testtest\"\n }\n */\nexport function fund(req, res) {\n  const {companyId} = req.params;\n  Company.findById(companyId)\n  .then(company => {\n    if (!company) {\n      res.status(400).json({error: 'Company not found'});\n      throw 'notFound';\n    }\n    if (!company.cardBuyId) {\n      res.status(400).json({error: 'This company doesn\\'t have a Card Buy ID'});\n      throw 'noId';\n    }\n    return company;\n  })\n  .then(company => {\n    const payload              = req.body;\n    payload.accountIdentifier  = company.cardBuyId;\n    payload.customerIdentifier = company.cardBuyCustomerId;\n    payload.creditCardToken    = company.cardBuyCcId;\n\n    tangoClient.fund(req.body, (err, tangoRes) => {\n      console.log('**************RES**********');\n      console.log(err);\n      console.log(tangoRes);\n      const [code, message, errorPath] = handleTangoResponse(err, tangoRes);\n\n      if (typeof code === 'number' && code > 0) {\n        res.status(code).json({\n          error: {\n            message,\n            invalidParameter: errorPath,\n            errors          : []\n          }\n        });\n        return;\n      }\n\n      return res.json(tangoRes);\n    });\n  })\n  .catch(async err => {\n    if (['notFound', 'noId'].indexOf(err) !== -1) {\n      return;\n    }\n\n    console.log('************************ERR IN ADDCARDS************************');\n    console.log(err);\n\n    await ErrorLog.create({\n      method: 'fund',\n      controller: 'tango.controller',\n      revision: getGitRev(),\n      stack: err.stack,\n      error: err\n    });\n\n    return res.status(500).json({error: 'Something went wront'});\n  });\n}\n"],"sourceRoot":"/home/ubuntu14/works/webstromProjects/gcmgr/gulp/es6"}